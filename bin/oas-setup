#!/bin/bash
## begin license ##
# 
# "Open Annotation Service" enables exchange, storage and search of
# heterogeneous annotations using a uniform format (Open Annotation format) and
# a uniform web service interface. 
# 
# Copyright (C) 2012 Meertens Instituut (KNAW) http://meertens.knaw.nl
# Copyright (C) 2012 Seecr (Seek You Too B.V.) http://seecr.nl
# 
# This file is part of "Open Annotation Service"
# 
# "Open Annotation Service" is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# "Open Annotation Service" is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with "Open Annotation Service"; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
# 
## end license ##
clear
set -o errexit

source /usr/lib/oas-functions.sh
isroot

INSTALL_INFO="$basedir/$(basename $0) on '$(date)'"
PROJECT_NAME=oas

cat << 'END_OF_BANNER'
                    ___  ___  ___  ___ _ _ 
              /\   / __|/ _ \/ _ \/ __| '_| 
              \//\ \__ \  __/  __/ (__| |   
  Crafted by  /\\/ |___/\___|\___|\___|_|   
              \/         
                   Software Craftsmanship
                   http://seecr.nl

END_OF_BANNER

messageWithEnter "Configuration of $PROJECT_NAME $PROJECT_VERSION

"

USERNAME=oas
id ${USERNAME} >/dev/null 2>&1 || useradd --system ${USERNAME} --shell /bin/false

GROUPNAME=$(id -ng ${USERNAME})

EXAMPLE_CONFIG_FILE=/usr/share/doc/oas/examples/oas.config
CONFIG_DIR=/etc/oas
CONFIG_FILE=${CONFIG_DIR}/oas.config
SERVICEDIR=/opt/${PROJECT_NAME}-services

########## Minimal userinput
ask_question "
The full server name is used for generating URLs for anonymous annotations.
Hence it is preferable that this name points back to this machine.

We discovered the following name to be pointing to this host. Press Enter
to used this value.  If you have a proxy with a better name pointing to this
machine, enter that name.

Server name" "$(hostname --fqdn)"
HOSTNAME=${USERINPUT}

ask_question "
The port number is used for generating URLs for anonymous annotations.
Enter a free port number greater than 1024.  OAS will use this port and
the next two numbers.

Server port" "8000"
SERVER_PORT=${USERINPUT}
SOLR_PORT=$(( ${SERVER_PORT}+1 ))
OWLIM_PORT=$(( ${SERVER_PORT}+2 ))

ask_question "Database path" "/var/lib/oas"
DATABASE_PATH=${USERINPUT}

ask_question "
This e-mails address is used in the OAI-PMH Identify response.

OAI Admin email-address:" ""
OAI_ADMIN_EMAIL=${USERINPUT}

## Set up database directory with Solr
test -d ${DATABASE_PATH} || mkdir --parents ${DATABASE_PATH}
chown ${USERNAME}:${GROUPNAME} ${DATABASE_PATH}
if [ ! -d ${DATABASE_PATH}/solr-state ]; then
    cp -r /usr/share/doc/oas/solr-data ${DATABASE_PATH}/solr-state
    chown --recursive ${USERNAME}:${GROUPNAME} ${DATABASE_PATH}/solr-state
fi

############# System wide UTF-8 ###########
sitecustomize="/etc/`pyversions -d`/sitecustomize.py"
if [ ! -f $sitecustomize ]; then
    touch $sitecustomize
fi
if ! grep 'setdefaultencoding' $sitecustomize > /dev/null; then
    echo "from sys import setdefaultencoding
setdefaultencoding('utf-8')" > $sitecustomize.tmp
    cat $sitecustomize >> $sitecustomize.tmp
    mv $sitecustomize.tmp $sitecustomize
fi

############# firewall rules #################
firewallscript=/etc/network/if-up.d/oas-firewall
cat << EOF > $firewallscript
#!/bin/bash
IPTABLES=/sbin/iptables
\$IPTABLES --list --numeric | grep "ACCEPT.*tcp.*dpt\:$SERVER_PORT " > /dev/null || \$IPTABLES -A INPUT -i eth0 -p tcp --dport $SERVER_PORT -j ACCEPT
EOF
chmod +x $firewallscript
$firewallscript
#################

### Config
test -d ${CONFIG_DIR} || mkdir --parents ${CONFIG_DIR}
cat ${EXAMPLE_CONFIG_FILE} | sed -e "
    s,^hostName\s*=.*$,hostName = $HOSTNAME,;
    s,^portNumber\s*=.*$,portNumber = $SERVER_PORT,;
    s,^solrPortNumber\s*=.*$,solrPortNumber = $SOLR_PORT,;
    s,^owlimPortNumber\s*=.*$,owlimPortNumber = $OWLIM_PORT,;
    s,^databasePath\s*=.*$,databasePath = $DATABASE_PATH,;
    s,^resolveBaseUrl\s*=.*$,resolveBaseUrl = http://${HOSTNAME}:$SERVER_PORT/resolve,;
    s,^publicDocumentationPath\s*=.*$,publicDocumentationPath = /usr/share/doc/oas/public,;
    s,^oai.repository.identifier\s*=.*$,oai.repository.identifier = ${HOSTNAME},;
    s,^oai.admin.email\s*=.*$,oai.admin.email = ${OAI_ADMIN_EMAIL},;
    " > ${CONFIG_FILE}

############### Server Service ####################
createService $USERNAME $GROUPNAME $SERVICEDIR ${PROJECT_NAME}-server "
## Generated by ${INSTALL_INFO}

export LANG=en_US.UTF-8

exec setuidgid ${USERNAME} start-oas-server --configFile=${CONFIG_FILE} 2>&1
"
prepareAndStartService $SERVICEDIR ${PROJECT_NAME}-server
############### /Server Service ####################


############### SOLR service ####################
createService $USERNAME $GROUPNAME $SERVICEDIR ${PROJECT_NAME}-solr "
## Generated by ${INSTALL_INFO}

export LANG=en_US.UTF-8

ulimit -n 100000
exec setuidgid ${USERNAME} start-oas-solr-server --configFile=$CONFIG_FILE --port=$SOLR_PORT --solrDataDir=$DATABASE_PATH/solr-state 2>&1
"
prepareAndStartService $SERVICEDIR ${PROJECT_NAME}-solr
############### /SOLR service ####################


############### TripleStore service ####################
createService $USERNAME $GROUPNAME $SERVICEDIR ${PROJECT_NAME}-triplestore "
## Generated by ${INSTALL_INFO}

export LANG=en_US.UTF-8

ulimit -n 100000
exec setuidgid ${USERNAME} start-oas-owlim-server --port=$OWLIM_PORT --storeLocation=$DATABASE_PATH/triplestore 2>&1
"
prepareAndStartService $SERVICEDIR ${PROJECT_NAME}-triplestore
############### /TripleStore service ####################


############### Delete service ####################
createService $USERNAME $GROUPNAME $SERVICEDIR ${PROJECT_NAME}-delete "
## Generated by ${INSTALL_INFO}

export LANG=en_US.UTF-8

ulimit -n 100000
exec setuidgid ${USERNAME} start-oas-userdelete-service --configFile=$CONFIG_FILE 2>&1
sleep 300
"
prepareAndStartService $SERVICEDIR ${PROJECT_NAME}-delete
############### /Delete service ####################


############### Resolve service ####################
createService $USERNAME $GROUPNAME $SERVICEDIR ${PROJECT_NAME}-resolve "
## Generated by ${INSTALL_INFO}

export LANG=en_US.UTF-8

ulimit -n 100000
exec setuidgid ${USERNAME} start-oas-resolve-service --configFile=$CONFIG_FILE 2>&1
sleep 300
"
prepareAndStartService $SERVICEDIR ${PROJECT_NAME}-resolve
############### /Resolve service ####################


############### Harvester service ####################
createService $USERNAME $GROUPNAME $SERVICEDIR ${PROJECT_NAME}-harvester "
## Generated by ${INSTALL_INFO}

export LANG=en_US.UTF-8

ulimit -n 100000
exec setuidgid ${USERNAME} start-oas-harvester --configFile=$CONFIG_FILE 2>&1
sleep 300
"
prepareAndStartService $SERVICEDIR ${PROJECT_NAME}-harvester
############### /Resolve service ####################


messageWithEnter "Finished setting up $PROJECT_NAME $PROJECT_VERSION

"
